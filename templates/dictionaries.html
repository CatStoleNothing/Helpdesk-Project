{% extends "base.html" %}

{% block title %}Справочники | Helpdesk{% endblock %}
{% block page_title %}Управление справочниками{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4><i class="fas fa-book me-2"></i>Управление справочниками</h4>
</div>

<div class="form-container">
    <ul class="nav nav-tabs mb-4" id="dictTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="departments-tab" data-bs-toggle="tab" data-bs-target="#departments" type="button" role="tab" aria-controls="departments" aria-selected="true">
                <i class="fas fa-building me-2"></i>Отделения
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="offices-tab" data-bs-toggle="tab" data-bs-target="#offices" type="button" role="tab" aria-controls="offices" aria-selected="false">
                <i class="fas fa-door-open me-2"></i>Кабинеты
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="positions-tab" data-bs-toggle="tab" data-bs-target="#positions" type="button" role="tab" aria-controls="positions" aria-selected="false">
                <i class="fas fa-user-tie me-2"></i>Должности
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab" aria-controls="categories" aria-selected="false">
                <i class="fas fa-tag me-2"></i>Категории
            </button>
        </li>
    </ul>

    <div class="tab-content" id="dictTabsContent">
        <!-- Вкладка Отделения -->
        <div class="tab-pane fade show active" id="departments" role="tabpanel" aria-labelledby="departments-tab">
            <!-- Форма поиска -->
            <div class="row mb-3">
                <div class="col-md-8">
                    <form class="d-flex" method="get" action="{{ url_for('dictionaries') }}#departments">
                        <input type="text" class="form-control me-2" name="dep_search" placeholder="Поиск по названию отделения..." value="{{ request.args.get('dep_search', '') }}">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-search me-1"></i>Найти
                        </button>
                        {% if request.args.get('dep_search') %}
                        <a href="{{ url_for('dictionaries') }}#departments" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </form>
                </div>
                <div class="col-md-4 text-end">
                    <a href="{{ url_for('add_department') }}" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i>Добавить отделение
                    </a>
                </div>
            </div>

            <!-- Таблица отделений -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">ID</th>
                            <th>Название</th>
                            <th style="width: 120px;">Статус</th>
                            <th style="width: 120px;">Дата начала</th>
                            <th style="width: 120px;">Дата окончания</th>
                            <th style="width: 120px;" class="text-center">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dep in departments %}
                        <tr>
                            <td>{{ dep.id }}</td>
                            <td><strong>{{ dep.name }}</strong></td>
                            <td>
                                {% if dep.is_active %}
                                    <span class="badge bg-success">Активно</span>
                                {% else %}
                                    <span class="badge bg-secondary">Неактивно</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if dep.active_from %}
                                    <small class="text-muted">{{ dep.active_from }}</small>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if dep.active_to %}
                                    <small class="text-muted">{{ dep.active_to }}</small>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('edit_department', dep_id=dep.id) }}" class="btn btn-sm btn-outline-primary" title="Редактировать">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ url_for('delete_department', dep_id=dep.id) }}"
                                       class="btn btn-sm btn-outline-danger"
                                       title="Удалить"
                                       onclick="return confirm('Удалить отделение &quot;{{ dep.name }}&quot;?\n\nВнимание: это действие нельзя отменить!')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                <p class="text-muted mb-0">Отделения не найдены</p>
                                {% if request.args.get('dep_search') %}
                                <small class="text-muted">Попробуйте изменить критерии поиска</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Вкладка Кабинеты -->
        <div class="tab-pane fade" id="offices" role="tabpanel" aria-labelledby="offices-tab">
            <!-- Форма поиска -->
            <div class="row mb-3">
                <div class="col-md-8">
                    <form class="d-flex" method="get" action="{{ url_for('dictionaries') }}#offices">
                        <input type="text" class="form-control me-2" name="office_search" placeholder="Поиск по названию кабинета..." value="{{ request.args.get('office_search', '') }}">
                        <select class="form-select me-2" name="office_dep_filter" style="max-width: 200px;">
                            <option value="">Все отделения</option>
                            {% for dep in all_departments %}
                                <option value="{{ dep.id }}" {% if request.args.get('office_dep_filter') == dep.id|string %}selected{% endif %}>
                                    {{ dep.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-search me-1"></i>Найти
                        </button>
                        {% if request.args.get('office_search') or request.args.get('office_dep_filter') %}
                        <a href="{{ url_for('dictionaries') }}#offices" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </form>
                </div>
                <div class="col-md-4 text-end">
                    <a href="{{ url_for('add_office') }}" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i>Добавить кабинет
                    </a>
                </div>
            </div>

            <!-- Таблица кабинетов -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">ID</th>
                            <th>Название</th>
                            <th>Отделение</th>
                            <th style="width: 120px;">Статус</th>
                            <th style="width: 120px;">Дата начала</th>
                            <th style="width: 120px;">Дата окончания</th>
                            <th style="width: 120px;" class="text-center">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for office in offices %}
                        <tr>
                            <td>{{ office.id }}</td>
                            <td><strong>{{ office.name }}</strong></td>
                            <td>
                                {% if office.department %}
                                    <span class="badge bg-info text-dark">{{ office.department.name }}</span>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if office.is_active %}
                                    <span class="badge bg-success">Активно</span>
                                {% else %}
                                    <span class="badge bg-secondary">Неактивно</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if office.active_from %}
                                    <small class="text-muted">{{ office.active_from }}</small>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if office.active_to %}
                                    <small class="text-muted">{{ office.active_to }}</small>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('edit_office', office_id=office.id) }}" class="btn btn-sm btn-outline-primary" title="Редактировать">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ url_for('delete_office', office_id=office.id) }}"
                                       class="btn btn-sm btn-outline-danger"
                                       title="Удалить"
                                       onclick="return confirm('Удалить кабинет &quot;{{ office.name }}&quot;?\n\nВнимание: это действие нельзя отменить!')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                <p class="text-muted mb-0">Кабинеты не найдены</p>
                                {% if request.args.get('office_search') or request.args.get('office_dep_filter') %}
                                <small class="text-muted">Попробуйте изменить критерии поиска</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Вкладка Должности -->
        <div class="tab-pane fade" id="positions" role="tabpanel" aria-labelledby="positions-tab">
            <!-- Форма поиска -->
            <div class="row mb-3">
                <div class="col-md-8">
                    <form class="d-flex" method="get" action="{{ url_for('dictionaries') }}#positions">
                        <input type="text" class="form-control me-2" name="pos_search" placeholder="Поиск по названию должности..." value="{{ request.args.get('pos_search', '') }}">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-search me-1"></i>Найти
                        </button>
                        {% if request.args.get('pos_search') %}
                        <a href="{{ url_for('dictionaries') }}#positions" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </form>
                </div>
                <div class="col-md-4 text-end">
                    <a href="{{ url_for('add_position') }}" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i>Добавить должность
                    </a>
                </div>
            </div>

            <!-- Таблица должностей -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">ID</th>
                            <th>Название</th>
                            <th style="width: 120px;">Статус</th>
                            <th style="width: 120px;">Дата начала</th>
                            <th style="width: 120px;">Дата окончания</th>
                            <th style="width: 120px;" class="text-center">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pos in positions %}
                        <tr>
                            <td>{{ pos.id }}</td>
                            <td><strong>{{ pos.name }}</strong></td>
                            <td>
                                {% if pos.is_active %}
                                    <span class="badge bg-success">Активно</span>
                                {% else %}
                                    <span class="badge bg-secondary">Неактивно</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if pos.active_from %}
                                    <small class="text-muted">{{ pos.active_from }}</small>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if pos.active_to %}
                                    <small class="text-muted">{{ pos.active_to }}</small>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('edit_position', pos_id=pos.id) }}" class="btn btn-sm btn-outline-primary" title="Редактировать">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ url_for('delete_position', pos_id=pos.id) }}"
                                       class="btn btn-sm btn-outline-danger"
                                       title="Удалить"
                                       onclick="return confirm('Удалить должность &quot;{{ pos.name }}&quot;?\n\nВнимание: это действие нельзя отменить!')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                <p class="text-muted mb-0">Должности не найдены</p>
                                {% if request.args.get('pos_search') %}
                                <small class="text-muted">Попробуйте изменить критерии поиска</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Вкладка Категории -->
        <div class="tab-pane fade" id="categories" role="tabpanel" aria-labelledby="categories-tab">
            <!-- Форма поиска -->
            <div class="row mb-3">
                <div class="col-md-8">
                    <form class="d-flex" method="get" action="{{ url_for('dictionaries') }}#categories">
                        <input type="text" class="form-control me-2" name="cat_search" placeholder="Поиск по названию категории..." value="{{ request.args.get('cat_search', '') }}">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="fas fa-search me-1"></i>Найти
                        </button>
                        {% if request.args.get('cat_search') %}
                        <a href="{{ url_for('dictionaries') }}#categories" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </form>
                </div>
                <div class="col-md-4 text-end">
                    <a href="{{ url_for('create_category') }}" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i>Добавить категорию
                    </a>
                </div>
            </div>

            <!-- Таблица категорий -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">ID</th>
                            <th>Название</th>
                            <th>Описание</th>
                            <th style="width: 120px;">Статус</th>
                            <th style="width: 120px;">Дата создания</th>
                            <th style="width: 120px;" class="text-center">Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cat in categories %}
                        <tr>
                            <td>{{ cat.id }}</td>
                            <td><strong>{{ cat.name }}</strong></td>
                            <td>{{ cat.description or '-' }}</td>
                            <td>
                                {% if cat.is_active %}
                                    <span class="badge bg-success">Активно</span>
                                {% else %}
                                    <span class="badge bg-secondary">Неактивно</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if cat.created_at %}
                                    <small class="text-muted">{{ cat.created_at }}</small>
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('edit_category', category_id=cat.id) }}" class="btn btn-sm btn-outline-primary" title="Редактировать">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{{ url_for('delete_category', category_id=cat.id) }}"
                                       class="btn btn-sm btn-outline-danger"
                                       title="Удалить"
                                       onclick="return confirm('Удалить категорию &quot;{{ cat.name }}&quot;?\n\nВнимание: это действие нельзя отменить!')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                <p class="text-muted mb-0">Категории не найдены</p>
                                {% if request.args.get('cat_search') %}
                                <small class="text-muted">Попробуйте изменить критерии поиска</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Обработка хеша в URL для переключения на нужную вкладку
document.addEventListener('DOMContentLoaded', function() {
    const hash = window.location.hash;
    if (hash) {
        const tabId = hash.replace('#', '') + '-tab';
        const tab = document.getElementById(tabId);
        if (tab) {
            const bsTab = new bootstrap.Tab(tab);
            bsTab.show();
        }
    }

    // Добавляем хеш при переключении вкладок
    const tabs = document.querySelectorAll('#dictTabs button[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const targetId = e.target.getAttribute('data-bs-target').replace('#', '');
            window.history.pushState(null, null, '#' + targetId);
        });
    });
});
</script>
{% endblock %}
